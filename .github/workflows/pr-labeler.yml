# set labels on Pull-Requests based on size of changes
# size is compared form firt to last commit in the pull request

name: Size Labeler/Checker

on:
  pull_request: [write]
        types: [opened, ready_for_review, synchronize, labeled, unlabeled]
jobs:
  label-changes:
    runs-on: ubuntu-latest

    steps:
      - name: Run actions/checkout@v4
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check changes and label
        run: |
          CHANGES=$(git diff --stat -b ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | awk '{changes = strtonum($4) + strtonum($6)} END {print changes}')
          echo "Changed files: $CHANGES"

          THRESHOLD=100

          PR_NUMBER="${{ github.event.number }}"
          API_URL="https://api.github.com/repos/${{ github.repository }}/issues/${PR_NUMBER}/labels"
          AUTH_HEADER="Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}"

          if [ "$CHANGES" -le "$THRESHOLD" ]; then
            LABEL="tiny"
            DELETE_LABEL="huge"
          else
            LABEL="huge"
            DELETE_LABEL="tiny"
          fi

          echo "Adding label: $LABEL"
          curl -X POST -H "$AUTH_HEADER" -d "{\"labels\":[\"$LABEL\"]}" "$API_URL"
          curl -X DELETE -H "$AUTH_HEADER" "$API_URL/$DELETE_LABEL"
